# GitHub Actions workflow for building and releasing MyApp
# =========================================================
# This workflow:
# 1. Builds .deb package when you push a version tag (v1.0.0, v1.1.0, etc.)
# 2. Creates GitHub release with .deb attached
# 3. Updates latest-version.txt for auto-update checking
#
# HOW TO RELEASE:
#   git tag v1.1.0
#   git push origin v1.1.0
# =========================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.1.0, etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Update version in source files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Update __init__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" myapp/__init__.py
          
          # Update latest-version.txt
          echo "$VERSION" > latest-version.txt
          
          echo "Updated version files to $VERSION"
      
      - name: Build .deb package
        run: |
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh ${{ steps.version.outputs.VERSION }}
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.deb
          generate_release_notes: true
          body: |
            ## Installation
            
            ### First-time install:
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/myapp_${{ steps.version.outputs.VERSION }}-1_all.deb
            sudo dpkg -i myapp_${{ steps.version.outputs.VERSION }}-1_all.deb
            sudo apt-get install -f -y  # Fix dependencies if needed
            ```
            
            ### If already installed:
            The app will auto-update automatically, or run:
            ```bash
            myapp update
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest-version.txt in main branch
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Configure git
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # Fetch main branch
          git fetch origin main
          git checkout main
          
          # Update version file
          echo "$VERSION" > latest-version.txt
          
          # Commit and push
          git add latest-version.txt
          git commit -m "Update latest-version.txt to $VERSION [skip ci]" || echo "No changes to commit"
          git push origin main
