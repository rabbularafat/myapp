# GitHub Actions workflow for building and releasing MyApp
# =========================================================
# TRIGGERS: Only on version tags (v1.0.0, v1.1.0, etc.)
#
# HOW TO RELEASE:
#   git tag v1.0.0
#   git push origin v1.0.0
# =========================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Building version: $VERSION"
      
      - name: Update version in source files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Update __init__.py
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" myapp/__init__.py
          
          # Update latest-version.txt
          echo "$VERSION" > latest-version.txt
          
          echo "âœ… Updated version files to $VERSION"
          cat myapp/__init__.py | head -5
      
      - name: Build .deb package
        run: |
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh ${{ steps.version.outputs.VERSION }}
          
          echo "ðŸ“¦ Built packages:"
          ls -la dist/
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.deb
          generate_release_notes: true
          body: |
            ## ðŸš€ MyApp v${{ steps.version.outputs.VERSION }}
            
            ### First-time Installation
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/myapp_${{ steps.version.outputs.VERSION }}-1_all.deb
            sudo dpkg -i myapp_${{ steps.version.outputs.VERSION }}-1_all.deb
            sudo apt-get install -f -y
            ```
            
            ### Already Installed?
            Your app will auto-update, or run:
            ```bash
            myapp update
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update latest-version.txt in main branch
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Configure git
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # Stash local changes
          git stash
          
          # Checkout main branch
          git checkout main
          
          # Update version file
          echo "$VERSION" > latest-version.txt
          
          # Commit and push
          git add latest-version.txt
          git commit -m "ðŸ”– Update latest-version.txt to $VERSION [skip ci]" || echo "No changes"
          git push origin main
          
          echo "âœ… Updated latest-version.txt on main branch"
